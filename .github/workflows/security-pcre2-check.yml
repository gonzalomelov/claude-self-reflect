name: PCRE2 Vulnerability Check

on:
  pull_request:
    paths:
      - 'Dockerfile*'
      - '.github/workflows/security-pcre2-check.yml'
  push:
    branches:
      - main
    paths:
      - 'Dockerfile*'
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

jobs:
  check-pcre2:
    runs-on: ubuntu-latest
    name: Check for CVE-2025-58050
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Check PCRE2 vulnerability in base images
      run: |
        echo "Checking for CVE-2025-58050 (PCRE2 heap buffer overflow)..."
        echo "============================================================"
        
        VULNERABLE=false
        
        # Check python:3.13-slim base image
        echo "Checking python:3.13-slim base image..."
        VERSION=$(docker run --rm python:3.13-slim sh -c "apt list --installed 2>/dev/null | grep 'libpcre2-8-0' | awk '{print \$2}'")
        
        if [[ "$VERSION" == "10.45-1" ]]; then
          echo "‚ùå VULNERABLE: python:3.13-slim contains libpcre2-8-0 $VERSION"
          echo "   CVE-2025-58050: Heap buffer overflow"
          VULNERABLE=true
        elif [[ "$VERSION" > "10.45" ]]; then
          echo "‚úÖ SAFE: python:3.13-slim contains libpcre2-8-0 $VERSION (patched)"
        else
          echo "‚ÑπÔ∏è  libpcre2-8-0 version: $VERSION"
        fi
        
        echo ""
        echo "Mitigation Status:"
        
        # Check if our Dockerfiles have mitigation
        MITIGATED=0
        TOTAL=0
        for dockerfile in Dockerfile.*; do
          if grep -q "python:3.13-slim" "$dockerfile" 2>/dev/null; then
            TOTAL=$((TOTAL + 1))
            if grep -q "CVE-2025-58050" "$dockerfile"; then
              echo "‚úÖ $dockerfile has mitigation"
              MITIGATED=$((MITIGATED + 1))
            else
              echo "‚ö†Ô∏è  $dockerfile lacks mitigation"
            fi
          fi
        done
        
        echo ""
        echo "Summary:"
        echo "  Base image vulnerable: $VULNERABLE"
        echo "  Dockerfiles with mitigation: $MITIGATED/$TOTAL"
        
        if [[ "$VULNERABLE" == "true" ]]; then
          echo ""
          echo "‚ö†Ô∏è  WARNING: Base image contains vulnerable PCRE2 10.45-1"
          echo "Our Dockerfiles include mitigation attempts, but the patch is not yet available."
          echo "Monitor: https://security-tracker.debian.org/tracker/CVE-2025-58050"
          
          # Don't fail the build, just warn
          # exit 1
        fi
    
    - name: Create issue comment if vulnerable
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
          ## üîí Security Check: CVE-2025-58050
          
          **PCRE2 Heap Buffer Overflow** in libpcre2-8-0 10.45-1
          
          ### Status
          - Base image \`python:3.13-slim\` contains vulnerable version
          - Mitigation added to Dockerfiles (explicit upgrade attempt)
          - Waiting for Debian to release patched package (10.46+)
          
          ### Risk Assessment
          - **Low risk** for this project (no user-controlled PCRE2 patterns)
          - Python's \`re\` module doesn't use PCRE2
          - Main exposure through system tools like \`grep -P\`
          
          ### Tracking
          - CVE: [CVE-2025-58050](https://security-tracker.debian.org/tracker/CVE-2025-58050)
          - Snyk Alert: Acknowledged and mitigated
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })