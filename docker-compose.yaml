volumes:
  qdrant_data:

services:
  # Fix permissions for config directory
  init-permissions:
    image: alpine
    command: chown -R 1000:1000 /config
    volumes:
      - ${CONFIG_PATH:-~/.claude-self-reflect/config}:/config
    profiles: ["watch", "mcp", "import", "async"]

  # Qdrant vector database - the heart of semantic search
  qdrant:
    image: qdrant/qdrant:v1.15.1
    container_name: claude-reflection-qdrant
    ports:
      - "${QDRANT_PORT:-6333}:6333"
    volumes:
      - qdrant_data:/qdrant/storage
      - ./config/qdrant-config.yaml:/qdrant/config/config.yaml:ro
    environment:
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__SERVICE__HTTP_PORT=6333
    restart: unless-stopped
    mem_limit: ${QDRANT_MEMORY:-4g}
    memswap_limit: ${QDRANT_MEMORY:-4g}

  # One-time import service (runs once then exits)
  importer:
    build:
      context: .
      dockerfile: Dockerfile.importer
    container_name: claude-reflection-importer
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-~/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-~/.claude-self-reflect/config}:/config
      - ./scripts:/scripts:ro
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-false}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-voyage-3}
      - BATCH_SIZE=${BATCH_SIZE:-50}
      - CHUNK_SIZE=${CHUNK_SIZE:-10}
      - PYTHONUNBUFFERED=1
    restart: "no"
    profiles: ["import"]
    command: python /scripts/import-conversations-unified.py

  # Continuous watcher service (optional) - DEPRECATED, use streaming-importer
  watcher:
    build:
      context: .
      dockerfile: Dockerfile.watcher
    container_name: claude-reflection-watcher
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-~/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-~/.claude-self-reflect/config}:/config
      - ./scripts:/scripts:ro
      - /tmp:/tmp
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-voyage-3}
      - WATCH_INTERVAL=${WATCH_INTERVAL:-5}
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-250}
      - CHUNK_SIZE=${CHUNK_SIZE:-5}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    profiles: ["watch-old"]
    mem_limit: 500m
    memswap_limit: 500m

  # Streaming importer service - Low memory continuous import
  streaming-importer:
    build:
      context: .
      dockerfile: Dockerfile.streaming-importer
    container_name: claude-reflection-streaming
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-~/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-~/.claude-self-reflect/config}:/config
      - ./scripts:/scripts:ro
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - WATCH_INTERVAL=${WATCH_INTERVAL:-1}  # Aggressive: 5x faster detection (minimum 1 second)
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-2000}  # Ultra conservative to prevent memory leak
      - OPERATIONAL_MEMORY_MB=${OPERATIONAL_MEMORY_MB:-1500}  # 1.5GB operational (25% of 8GB)
      - CHUNK_SIZE=${CHUNK_SIZE:-5}  # Minimal batch size 
      - HOT_WINDOW_MINUTES=${HOT_WINDOW_MINUTES:-15}  # Keep files HOT longer
      - MAX_COLD_FILES_PER_CYCLE=${MAX_COLD_FILES_PER_CYCLE:-5}  # Single file processing
      - PARALLEL_WORKERS=${PARALLEL_WORKERS:-8}  # Enable parallel embedding workers
      - PYTHONUNBUFFERED=1
      - LOGS_DIR=/logs
      - FASTEMBED_CACHE_PATH=/root/.cache/fastembed
      - CURRENT_PROJECT_PATH=${PWD}  # Pass current project path for prioritization
      - MALLOC_ARENA_MAX=2  # MEMORY LEAK FIX: Limit glibc malloc arenas
      - THREAD_POOL_WORKERS=${THREAD_POOL_WORKERS:-2}  # AsyncEmbedder thread pool size (speed vs stability)
      - THREAD_POOL_RECYCLE_FILES=${THREAD_POOL_RECYCLE_FILES:-50}  # Files before recycling thread pool
    restart: unless-stopped
    profiles: ["watch"]
    mem_limit: 8g
    memswap_limit: 8g

  # Async streaming importer - Ground-up async rewrite
  async-importer:
    build:
      context: .
      dockerfile: Dockerfile.async-importer
    container_name: claude-reflection-async
    depends_on:
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-~/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-~/.claude-self-reflect/config}:/config
      - ./scripts:/scripts:ro
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - WATCH_INTERVAL=${WATCH_INTERVAL:-5}
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-2000}
      - OPERATIONAL_MEMORY_MB=${OPERATIONAL_MEMORY_MB:-1500}
      - CHUNK_SIZE=${CHUNK_SIZE:-5}
      - HOT_WINDOW_MINUTES=${HOT_WINDOW_MINUTES:-15}
      - MAX_COLD_FILES_PER_CYCLE=${MAX_COLD_FILES_PER_CYCLE:-5}
      - THREAD_POOL_WORKERS=${THREAD_POOL_WORKERS:-2}
      - PYTHONUNBUFFERED=1
      - LOGS_DIR=/logs
      - FASTEMBED_CACHE_PATH=/root/.cache/fastembed
      - CURRENT_PROJECT_PATH=${PWD}
      - MALLOC_ARENA_MAX=2
    restart: unless-stopped
    profiles: ["async"]
    mem_limit: 4g
    memswap_limit: 4g

  # MCP server for Claude integration
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp-server
    container_name: claude-reflection-mcp
    depends_on:
      - qdrant
    environment:
      - QDRANT_URL=http://qdrant:6333
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - ENABLE_MEMORY_DECAY=${ENABLE_MEMORY_DECAY:-true}
      - DECAY_WEIGHT=${DECAY_WEIGHT:-0.3}
      - DECAY_SCALE_DAYS=${DECAY_SCALE_DAYS:-90}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    stdin_open: true
    tty: true
    profiles: ["mcp"]

networks:
  default:
    name: claude-reflection-network
    external: false
