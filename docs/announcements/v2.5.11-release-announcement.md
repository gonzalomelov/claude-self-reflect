# Claude Self-Reflect v2.5.11: Critical Cloud Mode Environment Variable Fix

**Updated**: August 12, 2025 | **Version**: 2.5.11

Claude Self-Reflect v2.5.11 resolves a critical bug that prevented proper cloud mode operation with Voyage AI embeddings. This emergency patch fix enables environment variables from Claude Code's `-e` flags to properly reach the MCP server Python process.

## Version 2.5.11 Release Notes

**Documentation** | **Migration Guide** | **MCP Reference**

This release addresses a fundamental infrastructure issue where MCP server environment configuration was not functioning as documented. Users attempting to enable cloud mode with Voyage AI embeddings were unable to do so despite correct configuration, as environment variables were not being propagated from the Claude Code interface to the Python MCP server process.

## Key Fix

### Environment Variable Propagation
- **Critical Issue**: Environment variables set via `claude mcp add -e PREFER_LOCAL_EMBEDDINGS=false` were not reaching the Python process
- **Root Cause**: Shell script `run-mcp.sh` did not export environment variables from Claude Code
- **Solution**: Enhanced shell script with explicit environment variable export and debug logging
- **Impact**: Cloud mode with Voyage AI embeddings now functions correctly

### Technical Implementation
The fix involves two key components:

```bash
# Enhanced run-mcp.sh with environment variable passing
if [ ! -z "$PREFER_LOCAL_EMBEDDINGS" ]; then
    export PREFER_LOCAL_EMBEDDINGS="$PREFER_LOCAL_EMBEDDINGS"
fi
```

```python
# Updated server.py with proper environment precedence
load_dotenv(env_path, override=False)  # Process environment takes priority
```

## Key Features

### Restored Cloud Mode Functionality
- **Voyage AI Integration**: 1024-dimensional vector embeddings for enhanced search accuracy
- **Environment Configuration**: Proper handling of `PREFER_LOCAL_EMBEDDINGS`, `VOYAGE_KEY`, and related variables
- **Debug Logging**: Startup logs show configuration status for troubleshooting

### Validated Compatibility
- **Local Mode**: FastEmbed 384-dimensional embeddings (default, privacy-focused)
- **Cloud Mode**: Voyage AI 1024-dimensional embeddings (enhanced accuracy)
- **Mode Switching**: Seamless transition between embedding types
- **Data Integrity**: Existing collections preserved during configuration changes

## Installation and Upgrade

### Quick Upgrade
```bash
npm install -g claude-self-reflect@2.5.11
```

### MCP Reconfiguration Required
After installation, users must reconfigure their MCP server:

```bash
# Remove existing MCP server
claude mcp remove claude-self-reflect

# Restart Claude Code completely

# Re-add with proper environment variables
claude mcp add claude-self-reflect "/path/to/run-mcp.sh" \
  -e PREFER_LOCAL_EMBEDDINGS="false" \
  -e VOYAGE_KEY="your-api-key" \
  -e QDRANT_URL="http://localhost:6333" \
  -s user
```

## Verification Steps

### Confirm Cloud Mode Operation
1. **Search Test**: Perform any reflection search query
2. **Check Embedding Type**: Search results should show `<embed>voyage</embed>` for cloud mode
3. **Verify Dimensions**: Cloud collections use 1024-dimensional vectors
4. **Debug Logs**: MCP server startup shows `PREFER_LOCAL_EMBEDDINGS: false`

### Confirm Local Mode Operation
1. **Configuration**: Set `PREFER_LOCAL_EMBEDDINGS="true"`
2. **Search Verification**: Results should show `<embed>local</embed>`
3. **Vector Dimensions**: Local collections use 384-dimensional vectors

## Technical Specifications

### Environment Variables Supported
- `PREFER_LOCAL_EMBEDDINGS`: Controls embedding mode (true/false)
- `VOYAGE_KEY`: API key for Voyage AI cloud embeddings
- `VOYAGE_KEY_2`: Alternative API key for fallback
- `QDRANT_URL`: Vector database connection URL
- `ENABLE_MEMORY_DECAY`: Time-based relevance weighting
- `DECAY_WEIGHT`, `DECAY_SCALE_DAYS`: Memory decay parameters
- `EMBEDDING_MODEL`: Local embedding model specification

### Compatibility Matrix
| Configuration | Embedding Type | Vector Dimensions | Privacy Level |
|---------------|----------------|-------------------|---------------|
| Local Mode (Default) | FastEmbed | 384 | Complete |
| Cloud Mode | Voyage AI | 1024 | API-dependent |

## Breaking Changes

None. This release is fully backward compatible and maintains existing functionality while restoring documented cloud mode capabilities.

## Performance Characteristics

- **Configuration Impact**: No performance degradation
- **Environment Parsing**: Negligible overhead during startup
- **Search Performance**: Cloud mode provides enhanced semantic accuracy
- **Memory Usage**: No additional memory requirements

## Security Enhancements

### Environment Variable Handling
- **Secure Logging**: API keys are masked in debug output
- **Process Isolation**: Environment variables properly scoped to MCP process
- **Fallback Behavior**: Graceful degradation to local mode if cloud configuration fails

## Use Cases Restored

### Development Team Collaboration
Cloud mode's enhanced semantic search accuracy enables better discovery of past solutions and architectural decisions across team conversations.

### Advanced Search Requirements
Projects requiring high-precision semantic matching can now access Voyage AI's superior embedding model capabilities.

### Hybrid Configuration
Teams can maintain both local (privacy) and cloud (accuracy) embedding collections simultaneously.

## Roadmap

With environment variable support now working correctly:
- Enhanced cloud mode features and optimizations
- Additional embedding model integrations
- Improved configuration management tools
- Advanced hybrid mode capabilities

## Getting Started

To restore cloud mode functionality:

1. **Upgrade Package**: `npm install -g claude-self-reflect@2.5.11`
2. **Reconfigure MCP**: Follow the upgrade instructions above
3. **Verify Operation**: Confirm embedding type in search results
4. **Test Functionality**: Perform reflection searches to validate operation

## Support

**Forums**: [GitHub Discussions](https://github.com/ramakay/claude-self-reflect/discussions)  
**Issues**: [GitHub Issues](https://github.com/ramakay/claude-self-reflect/issues)  
**Documentation**: [MCP Reference Guide](../development/MCP_REFERENCE.md)

## Acknowledgments

This critical fix was identified through comprehensive user feedback and testing. We appreciate the community's patience while this infrastructure issue was resolved and thank all users who reported cloud mode configuration difficulties.

---

For detailed technical specifications, see the [Release Notes](../RELEASE_NOTES_v2.5.11.md). For MCP configuration guidance, refer to the [MCP Reference Guide](../development/MCP_REFERENCE.md).