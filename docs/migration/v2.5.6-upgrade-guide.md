# Migration Guide: v2.5.5 â†’ v2.5.6

## Overview

Version 2.5.6 introduces **Tool Output Extraction** - a significant enhancement that captures command outputs and makes git file changes searchable. This guide will help you upgrade smoothly.

## What's Changed

### Metadata Schema v2
- Previous version: Metadata v1 (tool inputs only)
- New version: Metadata v2 (tool inputs + outputs)
- **Fully backward compatible** - no breaking changes

### New Fields Added
```python
{
    "metadata_version": 2,           # Was 1, now 2
    "git_file_changes": [...],       # NEW: Files from git outputs
    "tool_outputs": [...],           # NEW: Tool execution results
    # All existing fields preserved
}
```

## Upgrade Paths

### Option 1: Automatic (Recommended)
Simply continue using the system normally. New conversations will automatically use v2 metadata.

```bash
# Docker users - rebuild containers
docker compose down
docker compose build
docker compose --profile mcp up -d
```

### Option 2: Full Re-import
Re-import all conversations to add tool outputs to historical data.

```bash
# Docker users
docker compose run --rm importer

# Python users
source venv/bin/activate
python scripts/import-conversations-unified.py
```

### Option 3: Delta Update (Fastest)
Update existing conversations without re-importing vectors.

```bash
# Activate environment
source venv/bin/activate

# Test with limited files first
LIMIT=5 python scripts/delta-metadata-update.py

# Update all recent conversations (past week)
python scripts/delta-metadata-update.py

# Update specific time range
DAYS_TO_UPDATE=30 python scripts/delta-metadata-update.py
```

## Docker Users

### Step-by-Step Upgrade

1. **Stop services**
   ```bash
   docker compose down
   ```

2. **Pull latest changes**
   ```bash
   git pull origin main
   ```

3. **Rebuild containers**
   ```bash
   docker compose build
   ```

4. **Start services**
   ```bash
   docker compose --profile mcp up -d
   ```

5. **Optional: Re-import for historical data**
   ```bash
   docker compose run --rm importer
   ```

## Python Users (Non-Docker)

### Step-by-Step Upgrade

1. **Pull latest changes**
   ```bash
   git pull origin main
   ```

2. **Activate virtual environment**
   ```bash
   source venv/bin/activate  # or .venv/bin/activate
   ```

3. **Update dependencies**
   ```bash
   pip install -r requirements.txt
   ```

4. **Restart streaming importer**
   ```bash
   # Kill existing process
   pkill -f streaming-importer
   
   # Start new version
   python scripts/streaming-importer.py &
   ```

5. **Optional: Re-import for tool outputs**
   ```bash
   python scripts/import-conversations-unified.py
   ```

## Verification

### Test New Features

1. **Search by file**
   ```python
   # In Claude
   "Search for conversations that modified README.md"
   # Should find conversations with git operations on README.md
   ```

2. **Search by concept**
   ```python
   # In Claude
   "Find all docker-related conversations"
   # Should return conversations tagged with docker concept
   ```

3. **Check metadata version**
   ```bash
   # Check a recent import
   python scripts/check-collections.py
   # Should show metadata_version: 2
   ```

## Rollback (If Needed)

### Docker Users
```bash
# Revert to previous version
git checkout v2.5.5
docker compose down
docker compose build
docker compose --profile mcp up -d
```

### Python Users
```bash
# Revert code
git checkout v2.5.5

# Restart services
pkill -f streaming-importer
python scripts/streaming-importer.py &
```

## FAQ

### Q: Will this break existing searches?
A: No, fully backward compatible. Existing searches continue working.

### Q: Do I need to re-import everything?
A: No, only if you want tool outputs for historical conversations.

### Q: How much extra storage does this use?
A: Approximately 2-5KB per conversation with tool outputs.

### Q: Can I disable tool output extraction?
A: Not currently, but impact is minimal and provides significant benefits.

### Q: What if I'm using local embeddings?
A: Works the same - tool output extraction is independent of embedding type.

## Troubleshooting

### Issue: Searches not finding git file changes

**Solution**: Re-import or run delta update
```bash
python scripts/delta-metadata-update.py
```

### Issue: Docker container not rebuilding

**Solution**: Force rebuild
```bash
docker compose build --no-cache
```

### Issue: Streaming importer not picking up changes

**Solution**: Check logs and restart
```bash
docker compose logs streaming-importer
docker compose restart streaming-importer
```

## Performance Impact

- **Import time**: ~10ms additional per conversation
- **Search speed**: No measurable impact
- **Storage**: 2-5KB increase per conversation
- **Memory**: Negligible increase

## Support

For issues or questions:
1. Check [GitHub Issues](https://github.com/ramakay/claude-self-reflect/issues)
2. Review [Release Notes](../release-notes/v2.5.6-tool-output-extraction.md)
3. Ask in discussions

## Next Steps

After upgrading:
1. Test the new search capabilities
2. Consider re-importing if you need historical tool outputs
3. Update any custom scripts to use new search functions
4. Enjoy discovering connections between conversations!